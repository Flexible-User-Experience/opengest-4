{% extends 'admin/edit.html.twig' %}

{# override javascript includes #}
{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('bundles/fosjsrouting/js/router.min.js') }}"></script>
    <script src="{{ path('fos_js_routing_js', { callback: 'fos.Router.setData' }) }}"></script>

    <script type="text/javascript">
        jQuery(document).ready(function() {
             // Handler for .ready() called.
            var partnerNode = jQuery('#sonata-ba-field-container-{{ form.partner.vars.id }}');
            var cifNif = jQuery('#{{ form.cifNif.vars.id }}');
            var cifNifIcon = jQuery('#cif-nif-icon');
            {% if  admin.id(admin.subject) %}
                var deliveryNoteLinesTable = jQuery('#sonata-ba-field-container-{{ form.saleDeliveryNoteLines.vars.id }}');
                var numberOfDeliveryNoteLines = {{ form.saleDeliveryNoteLines.vars.data.count }};
                for (let i = 0; i < numberOfDeliveryNoteLines; i++) {
                    jQuery('#{{ form.saleDeliveryNoteLines.vars.id }}_' + i + '_saleItem').change(function(event) {
                            console.log('selctor changed number', i);
                            var saleItemId = event.val;
                            console.log('saleItem id', saleItemId);
                            if (saleItemId < 4){
                                updatePriceAndQuantityDeliveryNoteLine(i, saleItemId);
                            }
                            {#console.log('new value selected', jQuery('#{{ form.saleDeliveryNoteLines.vars.id }}_' + i + '_saleItem'));#}
                    }
                    );
                }

                function updatePriceAndQuantityDeliveryNoteLine(lineId, saleItemId) {
                    var hourPrice = {{ admin.subject.hourPrice }};
                    var minimumHours = {{ admin.subject.miniumHours }} + 0;
                    var displacement = {{ admin.subject.displacement }} + 0;
                    var minimumHolidayHours = {{ admin.subject.miniumHolidayHours }} + 0;
                    var increaseForHolidays = {{ admin.subject.increaseForHolidays }} + 0;
                    var increaseForHolidaysPercentage = {{ admin.subject.increaseForHolidaysPercentage }} + 0;
                    console.log('saleItemId inside', saleItemId);
                    if (saleItemId == 2) {
                        if (increaseForHolidaysPercentage) {
                            hourPrice = hourPrice*(1 + increaseForHolidaysPercentage);
                        }
                        if (increaseForHolidays) {
                            hourPrice = hourPrice + increaseForHolidays;
                        }
                        console.log('im in');
                    }
                    console.log('hourPrice', hourPrice);
                    jQuery('#{{ form.saleDeliveryNoteLines.vars.id }}_' + lineId + '_priceUnit').val(hourPrice);
                }
            {% endif %}

            deliveryNoteLinesTable.on('sonata.add_element', function (event) {
              console.log('trigger is fired ', event);
            })

             //on change
            partnerNode.change(function(event) {
                cifNifIcon.removeClass('hidden');
                var partnerId = event.val;
                console.log('PartnerID', partnerId);
              if (partnerId) {
                //on change Partner
                jQuery.get(Routing.generate('admin_app_partner_partner_getJsonPartnerById', {id: partnerId}), function () {
                }).done(function (response) {
                  updateNodesInfo(response);
                });
              }

            });

            //on load Partner
            {% if form.partner.vars.data is not null %}
                jQuery.get(Routing.generate('admin_app_partner_partner_getJsonPartnerById', { id: {{ form.partner.vars.data.id }} }), function() {
                }).done(function(response) {
                     updateNodesInfo(response);
                });
            {% endif %}

            function updateNodesInfo(response) {
                var partner = jQuery.parseJSON(response);
                cifNifIcon.addClass('hidden');
                cifNif.val(partner.cifNif);
            }

        });
    </script>
{% endblock %}
